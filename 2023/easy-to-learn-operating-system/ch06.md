# Chapter 06 교착상태

- 키워드
    - 교착상태(deadlock), 상호배제, 점유와 대기, 비선점, 원형 대기, 체크포인트, 롤백
- 질문 만들기
    - 아사현상과 교착상태의 차이점에 대해서 설명해주세요.
    - 교착 상태는 언제 발생하나요?
    - 교착 상태 필요 조건에 대해 설명해주세요.
    - 교착 상태는 어떻게 해결할 수 있을까요?
        - *[꼬리질문] 교착 상태 회피를 구현하는 방법에 대해서 설명해주세요.*
        - *[꼬리질문] 교착 상태 회피의 문제점은?*
        - *[꼬리질문] 타임아웃 방식의 문제점*
        - *[꼬리질문] 프로세스를 강제로 종류하는 방법에는 어떤 게 있나요?*
    - 교착 상태를 해결할 때 가장 큰 문제가 되는 게 뭔가요?
    - 데이터베이스의 교착 상태 처리에 대해서 설명해주세요.
        - [꼬리질문] 데이터베이스에서 타임아웃으로 인해 데이터 일관성이 깨지는 문제를 어떻게 해결할 수 있을까요?
- 질문 답안
    - 아사현상과 교착상태의 차이점에 대해서 설명해주세요.
        - 아사현상
            - **잘못된 정책**으로 인해, 특정 프로세스의 작업이 이루어지지 않는 것
                - 어떻게 해결?
                    - 프로세스가 **양보할 수 있는 상한선을 정하는 에이징**(나이먹기)으로 해결할 수 있다.
        - 교착상태
            - 여러 프로세스, 자연스럽게 발생
                - 에이징으로 해결할 수 없고 정책을 바꾼다고해서 해결할 수 없다.
                - 어떻게 해결?
                    - 예방, 회피, 검출
    - 교착 상태는 언제 발생하나요?
        - 시스템 자원 자원 사용
            - 시스템 자원을 할당받은 상태에서 다른 자원을 기다릴 때
            - 프린트, 스캐너
        - 공유 변수
            - 하나의 변수를 할당, 기다리는 상태
        - 응용프로그램
            - 데이터베이스, 데이터 일관성 목적으로 잠금을 이용하면서 교착상태에 빠질 수 있다.

    - 교착 상태 필요 조건에 대해서 설명해주세요.
        - 상호배제
            - 한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 **베타적인 자원**이어야 한다.
                - 베타적인 자원은 임계구역으로 보호되기 때문에 다른 프로세스가 동시에 사용할 수 없다.
                - 베타적인 자원을 사용하면 교착 상태가 발생한다.
        - 비선점
            - 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 빼앗을수 없어야 한다.
        - 점유와 대기
            - 프로세스가 어떤 자원을 할당 받은 상태에서 다른 자원을 기다리는 상태여야 한다.
        - 원형 대기
            - **점유와 대기를 하는 프로세스 간의 관계**가 **원**을 이뤄야 한다.
                - 점유와 대기 → 모두 교착 상태 X
                - **점유와 대기**를 하는 프로세스들 + **서로 방해하는 방향이 원을 이루면** → 프로세스들이 서로 양보하지 않기 때문에 교착상태에 빠진다.
        - 참고: 식사하는 철학자 예시
            - 상호배제
                - 포크 → 베타적인 자원
                    - 특정 포크를 한 사람이 사용하면 다른 사람은 사용할 수 없다.
                    - 교착 상태는 베타적인 자원을 여러 프로세스가 사용하는 경우 발생한다.
            - 비선점
                - 철학자 중 다른 철학자의 포크를 빼앗을 수 있다면 교착 상태는 발생하지 않음
            - 점유와 대기
                - 한 철학자가 왼쪽,오른쪽 포크를 모두 점유하거나 반대로 두 포크를 모두 기다리는 상태라면 교착상태는 발생하지 않는다.
            - 원형 대기
                - 철학자들이 **사각형 식탁**에서 한 줄로 앉아서 식사한다면 교착상태 발생하지 않음
                    - 식탁의 한 쪽 끝에서부터 철학자가 식사를 시작하고 다 사용한 포크를 내려놓으면 문제가 해결되기 때문

          > 상호배제와 비선점의 공통점
          >  - 임계구역과 관련이 있다.
          >  - 임계구역을 보호하기 위해 잠금 장치를 사용하면 상호 배제와 비선점 조건이 보장되기 때문에 교착상태가 발생할 수 있다.

    - 교착 상태는 어떻게 해결할 수 있을까요?
        - 교착 상태 예방
            - 교착 상태를 유발하는 **4가지 조건이 발생하지 않도록** 막는 법
                - 4가지 중 하나라도 막으면 교착상태가 발생하지 않는다.
            - 하지만 실효성이 적어 잘 사용하지 않음
            - 종류
                - 자원을 보호해야 하기 때문에 상호 배제 예방과 비선점 예방은 사용하기 어렵다.
                - 점유와 대기 예방, 원형 대기 예방은 프로세스 작업 방식을 제한하고 자원을 낭비하기 때문에 사용할 수 없다.
                - 상호 배제 예방
                    - 시스템 내에 있는 상호베타적인 자원, 즉 **공유할 수 없는 자원을 없애**버리는 방법
                    - 하지만 시스템 내에서 공유할 수 없는 자원이 있기 때문에 상호 배제를 무력화하기는 어려움
                - 비선점 예방
                    - 모든 자원을 빼앗을 수 있도록 만드는 방법
                    - 하지만 어떤 기준으로, 어떻게, 얼마나 빼앗을지 기준을 정하기가 어렵다.
                        - 그리고 아사현상이 발생할 수 있음.
                            - 예를들어 우선순위가 높은 프로세스가 우선순위가 낮은 프로세스를 빼앗을 수 있다고 가정하면 우선순위가 낮은 프로세스는 무조건 아사현상에 빠질 것이다.
                                - 아사현상을 에이징으로 해결 할 수 있는데 우선순위에 따라 양보해야 하는 상황에서는 교착 상태에 빠질 수밖에 없다. 따라서 비선점 조건을 무력화하기는 어렵다.
                                    - *[꼬리질문] 에이징이란?*
                                        - 프로세스가 **양보할 수 있는 상한선**을 정하는 방식
                                        - 프로세스가 자신의 순서를 양보할 때마다 나이를 한 살씩 먹어 최대 몇 살까지 양보하도록 규정하는 것
                - 점유와 대기 예방
                    - all or nothing
                        - 자원을 전부 할당하거나 할당하지 않는 방식 적용
                    - 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
                    - *[꼬리질문] 상호배제, 비선점과 다르게 점유와 대기 예방 방식이 의미가 있는 이유는?*
                        - 상호배제, 비선점은 자원에 대한 제약을 푸는 방식이다.
                            - 그런데 임계구역으로 보호받는 자원에 대한 제약을 풀기는 어려움
                        - 점유와 대기 예방은 자원이 아닌 **자원 사용 방식**을 바꿔 교착 상태를 처리한다는 점에서 의미가 있다.
                    - 단점
                        - 많은 자원을 필요로 하는 프로세스는 불리하다.
                            - 자원을 동시에 확보하기가 어려워 작업이 지연되는 아사 상태에 빠질 수 있음
                        - 자원 활용성 떨어짐
                            - 프로세스가 앞으로 필요할 자원까지 선점하기 때문에 자원 낭비가 심하다
                        - 프로세스가 자신이 사용하는 자원을 모두 알기는 어렵다.
                            - 프로세스가 필요한 자원 확보 후 실행했는데 추가로 필요한 자원이 생겨도 다시 확보하기가 어려움
                        - **결국 일괄 처리 방식으로 동작**
                            - 예를들어 키보드, 마우스 등의 시스템 자원은 대부분의 프로세스에서 필요로 하는 자원인데 이 자원들을 확보한 순서대로 실행한다면 그 자원을 획득한 프로세스가 작업을 끝내야 다른 프로세스가 작업을 할 수 있다. 결국 모든 작업은 일괄 처리 방식으로 처리되어 시스템 효율이 떨어진다.
                - 원형 대기 예방
                    - 점유와 대기를 하는 프로세스들이 원형을 이루지 못하게 막는 방법
                    - 자원을 한 방향으로만 사용하도록 설정하면 원형 대기를 예방할 수 있다.
                    - 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 것
                    - 예시
                        - 1-마우스, 2-하드디스크, 3-프린터
                        - 마우스를 할당받은 상태에서 프린터는 할당받을 수 있지만,
                        - 프린터를 할당받은 상태에서는 마우스를 할당받을 수 없다.
                    - 단점
                        - 프로세스 작업 진행에 유연성이 떨어진다.
                            - 위의 예시에서 프린터를 할당 받은 후에 마우스를 할당받으려고 하면 운영체제가 거부하는데 사용자 입장에서는 이런 자원 사용을 납득하기가 어려움.
                        - 자원에 번호를 어떻게 부여할지가 문제다.
                            - 자원에 어떻게 번호를 붙이든 자원 사용에 제약이 따름
        - 교착 상태 회피
            - **자원 할당량 조절**
            - 자원을 할당하다가 교착상태가 유발할 가능성이 있다고 판단되면 자원 할당을 중단하고 지켜보는 것
                - **교착 상태가 발생하지 않는 범위 내에서만 자원을 할당**하고, 교착 상태가 발생하는 범위에 있으면 프로세스를 대기시킨다.
                - 자원을 얼만큼 할당해야 교착 상태가 발생하지 않는다는 보장이 없기 때문에 실효성이 적음
            - 자원의 총수와 현재 할당된 자원의 수를 기준으로 시스템을 안정 상태와 불안정 상태로 나누고 시스템이 안정 상태를 유지하도록 자원을 할당한다.
                - 할당된 자원이 적으면 안정 상태가 크다.
                - 불안정 상태라고 해서 교착 상태가 항상 발생하는 것은 아니다.
                    - 가능성은 높아진다.
            - *[꼬리질문] 교착 상태 회피를 구현하는 방법에 대해서 설명해주세요.*
                - 대표적인 방법으로는 **은행원 알고리즘**이 있다.
                    - 은행이 대출해 주는 방식, 즉 대출 가능한 범위(안정 상태)내면 대출이 허용되지만, 그렇지 않으면 거부하는 것과 유사하다.
                    - 예시
                        - 우동10인분, 스파게티20분 분량의 재료가 준비됐다면 은행원 알고리즘에서는 10명 이내로 예약을 받는다.
                            - 왜냐하면 12명을 예약받았는데 12명 모두 우동을 주문하면 문제가 발생하기 때문.
                            - **최악의 경우를 기준으로** 삼아 문제 상황을 철저하게 피해 교착상태를 막는다.
            - *[꼬리질문] 교착 상태 회피의 문제점은?*
                - 프로세스가 자신이 사용할 **모든 자원을 미리 선언**해야하는데 쉽지 않다.
                    - 그리고 선언한 자원이 정확하지 않으면 교착 상태 회피에서도 교착 상태가 발생할 수 있다.
                - 시스템의 **전체 자원수가 고정적**이어야 한다.
                    - 은행원 알고리즘에서 안정, 불안정 상태를 파악하려면 전체 자원수가 고정적이어야 한다. 그런데 일시적인 고장이나 새로운 자원이 추가되는 일이 잦기 때문에 전체 자원수는 유동적이다.
                - **자원이 낭비**된다.
                    - 모든 불안정 상태가 교착상태가 되는 것은 아님에도 자원을 할당하지 않는 것은 자원 낭비다.
        - 교착 상태의 검출
            - 어떤 제약 X
            - **자원 할당 그래프 모니터링** → 만약 교착상태가 발생하면 교착 상태 회복 단계가 진행된다.
            - 교착 상태 검출
                - 종류
                    - 가벼운
                        - 타임아웃
                            - 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법
                            - *[꼬리질문] 타임아웃 방식의 문제점*
                                - 엉뚱한 프로세스가 강제 종료될 수 있다.
                                    - 교착 상태가 아닌 다른 이유로 작업이 중단된 프로세스가 종료될 수 있다.
                                - 모든 시스템에 적용할 수 없다.
                                    - 하나의 운영체제 내에서 동작하는 프로세스들은 그 상태를 운영체제가 감시하기 때문에 타임아웃 방법을 적용할 수 있다.
                                    - 그런데 분산 데이터베이스는 데이터가 여러 시스템에 나위어 있고 각 시스템이 네트워크로 연결된다.
                                        - 따라서 원격지에 있는 프로세스가 응답이 없는 것이 교착 상태 때문인지, 네트워크 문제인지, 단순히 처리가 늦어지는 건지 정확하게 알기가 어렵다.
                                - → 그러므로 타임아웃 방법을 적용하여 교착 상태를 파악하기 어렵다.
                    - 무거운
                        - 자원 할당 그래프

                          자원 할당 그래프를 보면 시스템 내의 프로세스가 어떤 자원을 사용하고 있는지 혹은 기다리는지 알 수 있다.

                            - 장점
                                - **작업 방식을 제한하지 않으면서** 교착 상태를 정확하게 파악할 수 있다.
                            - 단점
                                - 자원 할당 그래프를 유지하고, 갱신하고, 사이클을 검사하는 추가 작업으로 인해 **오버헤드** 발생
                                    - 이런 추가 작업을 줄이기 위해 자원이 할당될 때마다 사이클 검사를 하는 게 아니라 일정 시간마다 하는 방법도 있다.
        - 교착상태의 회복
            - 교착 상태가 검출되면 교착 상태를 푸는 후속 작업을 하는데 이를 교착 상태 회복이라고 한다.
                - 회복 단계에서 프로세스 강제 종료를 한다.
                    - *[꼬리질문] 프로세스를 강제로 종류하는 방법에는 어떤 게 있나요?*
                        - 교착 상태를 일으킨 모든 프로세스 종료
                        - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
                            - 어떤 기준으로?
                                - 우선순위가 낮은 프로세스를 먼저 종료한다.
                                - 우선순위가 같으면 작업 시간이 짧은 프로세스를 먼저 종료한다.
                                - 위에 두 조건이 같으면 자원을 많이 사용하는 프로세스를 먼저 종료한다.
            - 교착 상태 회복 단계에서는 **프로세스 강제 종료**하는 일 뿐만 아니라 **강제 종료된 프로세스가 실행되기 전에 시스템을 복구하는 일**도 해야 한다.
                - 시스템 복구는 명령어가 실행될 때마다 **체크포인트**를 만들어 가장 최근의 검사 시점으로 돌아가는 식으로 한다.
                    - 이 방법은 작업량이 너무 많아서 시스템에 부하를 주기 때문에 체크포인트를 무분별하게 사용해선 안되고 선택적으로 사용해야 한다.
    - 교착 상태를 해결할 때 가장 큰 문제가 되는 게 뭔가요?
        - 시스템에 따라서 교착 상태가 발생하는 빈도나 시스템에 미치는 영향이 다른 것
            - 예시
                - 공장 운영 시스템, 무기 제어 시스템 등에서 교착 상태가 발생하면 위험하다.
                - 그에 비해, 일반인이 사용하는 운영체제는 교착상태를 해결하기 위해 노력과 시간을 쓰기보단 차라리 진행이 안되는 프로세스를 죽이거나 최악의 경우 전체 시스템을 재부팅 시키는 게 효율적이다.
                    - 그래서 대부분 유닉스나 윈도우같은 대중적인 운영체제는 타임아웃 방식을 사용한다.
    - 데이터베이스의 교착 상태 처리에 대해서 설명해주세요.
        - 데이터의 일관성이 깨지면 안되기 때문에 운영체제보다 복잡하다.
            - 데이터를 조작할 때는 반드시 잠금을 걸어야 하고 여러 개의 잠금을 얻어 작업하던 중 타임아웃으로 프로세스가 종료되면 일부 데이터에 문제가 발생할 수도 있다.
        - [꼬리질문] 데이터베이스에서 타임아웃으로 인해 데이터 일관성이 깨지는 문제를 어떻게 해결할 수 있을까요?
            - 체크포인트, 롤백와 롤백을 사용한다.
            - 체크포인트
                - 작업을 하다가 문제가 발생하면 저장된 상태로 되돌아오기 위한 표시
                - 체크포인트를 설정하면 현재 시스템 상태가 하드디스크에 저장되며 이 데이터를 스냅샵이라고 한다.
            - 롤백
                - 작업을 하다가 문제가 발생하면 과거의 체크포인트로 되돌아가는 것